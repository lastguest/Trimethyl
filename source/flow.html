<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='Flow'>/**
</span> * @class  Flow
 * @author  Flavio De Stefano &lt;flavio.destefano@caffeinalab.com&gt;
 * Manage the app windows flow, tracking optionally with Google Analitycs
 */

<span id='Flow-property-config'>/**
</span> * * **useNav**: Use a Navigation Controller instead opening windows directly. Default: `true`
 * * **trackWithGA**: Send the trackScreen directly to GA module. Default: `true`
 * @type {Object}
 */
var config = _.extend({
	useNav: true,
	trackWithGA: true
}, Alloy.CFG.T.flow);
exports.config = config;

var $_cur_CTRL_AS_STR = null;
var $_cur_CTRL = null;
var $_cur_CTRL_ARGS = null;
var $_cur_WIN = null;

var hist = [];

var navNR = null;
var $nav = null;

<span id='Flow-method-setNavigationController'>/**
</span> * Set the navigation controller used to open windows
 *
 * @param {Ti.UI.iOS.NavigationWindow} nav The instance of the navigation controller
 * @param {Boolean} [openNow] Specify if call instantly the open on the navigation controller
 */
function setNavigationController(nav, openNow) {
	$nav = nav;

	if (openNow) {
		$nav.open();

		// If is stored navNextRoute object, forward the request to current navigator
		if (navNR) {
			var tmp = { &quot;open&quot;: open, &quot;openWindow&quot;: openWindow };
			tmp[navNR.method](navNR.controller, navNR.args, navNR.opt);
			navNR = null;
		}

	}
}
exports.setNavigationController = setNavigationController;


<span id='Flow-method-startup'>/**
</span> * Set, in a single way, the global NavigationWindow (and open it), the Index Controller and the Index Window
 *
 * This method, is typically called on startup, on the index.js, like this:
 *
 * ```
 * T(&#39;flow&#39;).startup($, $.nav, $.win);
 * ```
 *
 * @param  {Alloy.Controller} 		controller
 * @param  {Ti.UI.NavigationWindow} nav
 * @param  {Ti.UI.Window} 				win
 */
function startup(controller, nav, win) {
	setNavigationController(nav, true);
	setCurrentController(controller);
	setCurrentWindow(win);
}
exports.startup = startup;


<span id='Flow-method-getNavigationController'>/**
</span> * Return the instance set of navigation controller
 *
 * @return {Ti.UI.NavigationWindow} The navigation controller
 */
function getNavigationController() {
	return $nav;
}
exports.getNavigationController = getNavigationController;


<span id='Flow-method-closeController'>/**
</span> * Close an Alloy.Controller
 *
 * If a `close` function is attached to controller exports, call that
 *
 * Otherwise simply close the main window
 *
 * @param  {Alloy.Controller} controller The controller to close
 */
function closeController(controller) {
	if (!controller) return;

	if (&#39;close&#39; in controller) {
		controller.close();
	} else {
		controller.getView().close();
	}
}
exports.closeController = closeController;


<span id='Flow-method-openWindow'>/**
</span> * Open a Window in current flow.
 *
 * If a navigation controller is set, open with it.
 *
 * @param  {Ti.UI.Window} $window 	The window object
 * @param  {Object} [opt]        	The arguments passed to the NavigationWindow.openWindow or the Controller.Window.open
 */
function openWindow($window, opt) {
	opt = opt || {};

	if (config.useNav) {

		if (!$nav) {
			navNR = { method: &#39;openWindow&#39;, controller: controller, args: opt };
			Ti.API.warn(&quot;Flow: A NavigationController is not defined yet, waiting for next assignment&quot;);
			return;
		}
		$nav.openWindow($window, opt);

	} else {
		$window.open(opt || {});
	}
}
exports.openWindow = openWindow;


<span id='Flow-method-openDirect'>/**
</span> * Require an Alloy.Controller without passing it to the navigation window
 *
 * This is tracked with Google Analitycs
 *
 * @param  {String} controller The name of the controller
 * @param  {Object} [args]     The args passed to the controller
 * @param  {Object} [opt]        Additional arguments
 * @param  {String} [key]			Optional key that identify this controller
 */
function openDirect(controller, args, opt, key) {
	key = key || controller;

	Ti.API.debug(&quot;Flow: opening directly &#39;&quot;+controller+&quot;&#39; with args &quot;+JSON.stringify(args));

	// Open the controller
	var $ctrl = Alloy.createController(controller, args || {});

	// Track with Google Analitycs
	if (config.trackWithGA) {
		require(&#39;T/ga&#39;).trackScreen(key);
	}

	return $ctrl;
}
exports.openDirect = openDirect;


<span id='Flow-method-open'>/**
</span> * Require an Alloy.Controller and open the main window associated with it
 *
 * If a navigation controller is set, open with it
 *
 * A `close` event is automatically attached to the main window to call sequentially
 * `Controller.beforeDestroy` (if defined) and `Controller.destroy`
 *
 * This is tracked with Google Analitycs
 *
 * @param  {String} controller The name of the controller
 * @param  {Object} [args]       The arguments passed to the controller
 * @param  {Object} [opt]        Additional arguments:
 * * **openArgs**: The arguments passed to the Window.open
 * @param  {String} [key]			Optional key that identify this controller
 * @return {Alloy.Controller}    The controller instance
 */
function open(controller, args, opt, key) {
	args = args || {};
	opt = opt || {};
	key = key || controller;

	Ti.API.debug(&quot;Flow: opening &#39;&quot;+controller+&quot;&#39; with args &quot;+JSON.stringify(args));

	var $ctrl = Alloy.createController(controller, args);
	var $win = $ctrl.getView();

	if (config.useNav) {

		if (!$nav) {
			navNR = { method: &#39;open&#39;, controller: controller, args: args, opt: opt };
			Ti.API.warn(&quot;Flow: A NavigationController is not defined yet, waiting for next assignment&quot;);
			return;
		}
		$nav.openWindow($win, opt.openArgs || {});

	} else {
		$win.open(opt.openArgs || {});
	}

	// Attach events
	$win.addEventListener(&#39;close&#39;, function(){
		if (&#39;beforeDestroy&#39; in $ctrl) $ctrl.beforeDestroy();
		$ctrl.destroy();
		$ctrl = null;
		$win = null;
	});

	// Track with Google Analitycs
	if (config.trackWithGA) {
		require(&#39;T/ga&#39;).trackScreen(key);

		try {

			// Track time with GA

			var startFocusTime = null;
			$win.addEventListener(&#39;focus&#39;, function(){
				startFocusTime = +(new Date());
			});

			$win.addEventListener(&#39;blur&#39;, function(){
				if (startFocusTime) {
					require(&#39;T/ga&#39;).time(key, +(new Date())-startFocusTime);
				}
			});

		} catch (ex) {}
	}

	// Put in the history current controller an its args
	hist.push({
		controller: controller,
		args: args
	});

	// Close current controller if not using NavigationWindow based stack
	if (!config.useNav &amp;&amp; !opt.singleTask &amp;&amp; $_cur_CTRL) {
		closeController($_cur_CTRL);
	}

	$_cur_CTRL_AS_STR = controller;

	$_cur_CTRL_ARGS = args;
	$_cur_CTRL = $ctrl;
	$_cur_WIN = $win;

	return $ctrl;
}
exports.open = open;


<span id='Flow-method-back'>/**
</span> * Close current controller and go back the the previous controller
 */
function back() {
	if (hist.length&lt;2) return;
	closeCurrent();
	var last = hist.pop();
	open(last.controller, last.args);
}
exports.back = back;


<span id='Flow-method-getCurrent'>/**
</span> * Get an object with currents controller, args and window
 *
 * @return {Object} [description]
 */
function getCurrent() {
	return {
		controller: $_cur_CTRL,
		window: $_cur_WIN,
		args: $_cur_CTRL_ARGS,
	};
}
exports.getCurrent = getCurrent;

<span id='Flow-method-current'>/**
</span> * @method current
 * @inheritDoc #getCurrent
 * Alias for {@link #getCurrent}
 */
exports.current = getCurrent;

<span id='Flow-method-getCurrentController'>/**
</span> * Return current controller
 *
 * @return {Alloy.Controller}
 */
function getCurrentController() {
	return $_cur_CTRL;
}
exports.getCurrentController = getCurrentController;

<span id='Flow-method-setCurrentController'>/**
</span> * Set current controller
 *
 * @param {Alloy.Controller} controller
 */
function setCurrentController(controller) {
	$_cur_CTRL = controller;
	$_cur_WIN = controller.getView();
}
exports.setCurrentController = setCurrentController;

<span id='Flow-method-controller'>/**
</span> * @method controller
 * @inheritDoc #getCurrentController
 * Alias for {@link #getCurrentController}
 */
exports.controller = getCurrentController;

<span id='Flow-method-closeCurrent'>/**
</span> * Close current controller
 */
function closeCurrent() {
	hist.pop();
	closeController($_cur_CTRL);
}
exports.closeCurrent = closeCurrent;

<span id='Flow-method-getHistory'>/**
</span> * Get the history of controllers used
 *
 * @return {Array}
 */
function getHistory() {
	return hist;
}
exports.getHistory = getHistory;

<span id='Flow-method-clearHistory'>/**
</span> * Clear the history of controllers used
 */
function clearHistory(){
	hist = [];
}
exports.clearHistory = clearHistory;

<span id='Flow-method-getCurrentWindow'>/**
</span> * Get current Window
 * @return {Ti.UI.Window}
 */
function getCurrentWindow() {
	return $_cur_WIN;
}
exports.getCurrentWindow = getCurrentWindow;

<span id='Flow-method-setCurrentWindow'>/**
</span> * Set current Window
 * @param {Ti.UI.Window} $window
 */
function setCurrentWindow($window) {
	$_cur_WIN = $window;
}
exports.setCurrentWindow = setCurrentWindow;

<span id='Flow-method-window'>/**
</span> * @method window
 * @inheritDoc #getCurrentWindow
 * Alias for {@link #getCurrentController}
 */
exports.window = getCurrentWindow;
</pre>
</body>
</html>
