<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='WebAlloy'>/**
</span> * @class  	WebAlloy
 * @author  Flavio De Stefano &lt;flavio.destefano@caffeinalab.com&gt;
 *
 * This is an entire Âµ-web-framework to write Titanium-Alloy apps in HTML/CSS/JS, without native objects.
 *
 * The unique method `WebAlloy.createView` create a WebView with static html inside.
 *
 * To work with WebAlloy, you have to replicate the exact structure in the app directory (Alloy).
 *
 * ### Globals
 *
 * #### app.css
 * Global CSS included in each view.
 *
 * #### app.jslocal
 * Global JS included in each view.
 *
 *	#### controllers/foo.jslocal
 *	Javascript file included in the specific controller, after app.jslocal and jquery.jslocal
 *
 * #### views/foo.tpl
 * HTML/TPL (underscore templating system) file that is parsed and written in the static HTML.
 *
 * #### styles/foo.css
 * CSS file included in the specific controller.
 *
 * ### lib/**.jslocal
 * Put your jslocal files here, they are automatically appended at the end of the HTML.
 *
 * When you have replicated this structure, you can just call:
 *
 * ```
 * WebAlloy.createView({
 * 	name: &#39;foo&#39;,
 * 	webdata: { ... },
 * 	...
 * });
 * ```
 *
 * The **name** arg is to specific the files to load.
 *
 * The **webdata** object is passed to the HTML file and rendered with the Undescore template system.
 *
 *	All the other arguments are Ti-UI specific for the classic WebView.
 *
 * ### HTML output
 *
 * So, the final result is an HTML string passed to the WebView, like this:
 *
 * ```
 * &lt;!DOCTYPE html&gt;
 * &lt;html&gt;
 * 	&lt;head&gt;
 * 		... metas ...
 * 		&lt;style&gt;{{ app.css }}&lt;/style&gt;
 * 		&lt;style&gt;{{ your_controller.css }}&lt;/style&gt;
 * 	&lt;/head&gt;
 * 	&lt;body&gt;
 * 		&lt;div id=&quot;main&quot;&gt;
 * 			{{ controller.tpl (rendered in undescore with webdata argument) }}
 * 		&lt;/div&gt;
 * 		&lt;script&gt;{{ lib/**.jslocal }}&lt;/script&gt;
 * 		&lt;script&gt;{{ app.jslocal }}&lt;/script&gt;
 * 		&lt;script&gt;{{ controller.jslocal }}&lt;/script&gt;
 * 	&lt;/body&gt;
 * &lt;/html&gt;
 * ```
 *
 * ### WebView additional method
 *
 * Basically, you can interact with DOM elements with `evalJS`.
 *
 * There are some proxy methods designed to interact directly:
 *
 * #### render({ data })
 *
 * Re-render the template with new data passed.
 *
 * #### call(...)
 *
 * Call a function in the WebView.
 *
 * For example, `$.wv.call(&#39;foo&#39;, 1, 2, {x:1})` will be converted to js in `foo(1, 2, {x:1})`.
 *
 * #### $(selector).call(...)
 *
 * Call a function in a DOM-RAW object.
 *
 * #### $(selector).get(...)
 *
 * Get a property of a DOM-RAW object.
 *
 * #### $(selector).set(...)
 *
 * Set a property of a DOM-RAW object.
 *
 */

<span id='WebAlloy-property-config'>/**
</span> * @type {Object}
 */
var config = _.extend({
}, Alloy.CFG.T.weballoy);
exports.config = config;

var libDir = [];

function embedCSS(f) {
	var file = Ti.Filesystem.getFile(f);
	if (!file.exists()) return &#39;&#39;;
	var read = file.read().text;
	file = null;
	return &#39;&lt;style id=&quot;__weballoy_&#39;+f+&#39;&quot; type=&quot;text/css&quot;&gt;&#39;+read+&#39;&lt;/style&gt;&#39;;
}

function embedJS(f) {
	var file = Ti.Filesystem.getFile(f);
	if (!file.exists()) return &#39;&#39;;
	var read = file.read().text;
	file = null;
	return &#39;&lt;script id=&quot;__weballoy_&#39;+f+&#39;&quot; type=&quot;text/javascript&quot;&gt;&#39;+read+&#39;&lt;/script&gt;&#39;;
}

<span id='WebAlloy-method-createView'>/**
</span> * @method createView
 * @param  {Object} args Arguments for the view.
 * @return {Ti.UI.WebView}
 */
exports.createView = function(args) {
	var $ui = Ti.UI.createWebView(_.extend({
		disableBounce: true,
		backgroundColor: &quot;transparent&quot;
	}, args));

	// Include head (styles)
	var html = &#39;&lt;!DOCTYPE html&gt;&#39;;
	html += &#39;&lt;html&gt;&lt;head&gt;&#39;;
	html += &#39;&lt;meta charset=&quot;utf-8&quot; /&gt;&#39;;
	html += &#39;&lt;meta name=&quot;viewport&quot; content=&quot;width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=no;&quot; /&gt;&#39;;

	html += embedCSS(&#39;web/app.css&#39;);
	html += embedCSS(&#39;web/styles/&#39;+args.name+&#39;.css&#39;);

	html += &#39;&lt;/head&gt;&lt;body&gt;&#39;;

	// Include template
	html += &#39;&lt;div id=&quot;main&quot;&gt;&#39;;
	var tplf = Ti.Filesystem.getFile(&#39;web/views/&#39;+args.name+&#39;.tpl&#39;);
	if (tplf.exists()) {
		$ui.tpl = _.template(tplf.read().text);
		html += $ui.tpl(args.webdata);
	} else {
		Ti.API.warn(&quot;WebAlloy: no view found [&quot;+args.name+&quot;]&quot;);
	}
	tplf = null;
	html += &#39;&lt;/div&gt;&#39;;

	// Include libs
	_.each(libDir, function(js) {
		html += embedJS(js);
	});

	// Include footer
	html += embedJS(&#39;web/app.jslocal&#39;);
	html += embedJS(&#39;web/controllers/&#39;+args.name+&#39;.jslocal&#39;);
	html += &#39;&lt;/body&gt;&lt;/html&gt;&#39;;

	$ui.html = html;

	$ui._ = function(js) {
		return $ui.evalJS(js);
	};

	$ui.call = function() {
		var args = _.map(Array.prototype.slice.call(arguments, 1), function(a) { return JSON.stringify(a); });
		return $ui._( arguments[0] + &#39;(&#39; + args.join(&#39;,&#39;) + &#39;)&#39; );
	};

	$ui.$ = function(selector) {
		return {
			call: function() {
				var args = _.map(Array.prototype.slice.call(arguments, 1), function(a) { return JSON.stringify(a); });
				return $ui._( &#39;document.querySelector(&quot;&#39; + selector + &#39;&quot;).&#39; + arguments[0] + &#39;(&#39; + args.join(&#39;,&#39;) + &#39;)&#39; );
			},
			get: function(name) {
				return $ui._( &#39;document.querySelector(&quot;&#39; + selector + &#39;&quot;).&#39; + name );
			},
			set: function(name, value) {
				return $ui._( &#39;document.querySelector(&quot;&#39; + selector + &#39;&quot;).&#39; + name + &#39; = &#39; + JSON.stringify(value) );
			}
		};
	};

	$ui.render = function(data) {
		$ui.$(&#39;#main&#39;).set(&#39;innerHTML&#39;, $ui.tpl(data));
	};

	return $ui;
};


(function init() {

	_.each(Ti.Filesystem.getFile(&#39;web/lib&#39;).getDirectoryListing(), function(js) {
		libDir.push(&#39;web/lib/&#39;+js);
	});

})();</pre>
</body>
</html>
