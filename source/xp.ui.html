<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='XPUI'>/**
</span> * @class  XPUI
 * @author  Flavio De Stefano &lt;flavio.destefano@caffeinalab.com&gt;
 * Provide **CROSS-PLATFORM** UI elements to handle differences between platforms
 *
 * ** non-CommonJS module**
 *
 * You have to use in Alloy with `module=&quot;xp.ui&quot;`
 *
 * Inspired to @FokkeZB UTIL. Thanks! :)
 * https://github.com/FokkeZB/UTiL/tree/master/xp.ui
 *
 */


/* ============ NAVIGATIONWINDOW =============== */

if (!OS_IOS) {

	/*
	NavigationWindow Android fallback provided by @FokkeZB
	*/
	var NavigationWindow = function(args) {
		this.args = args || {};
		this.windows = [];
	};

	NavigationWindow.prototype = {

		open: function(args) {
			return this.openWindow(this.args.window, args);
		},

		close: function(callback) {
			if (callback) this.closeCallback = callback;

			if (this.windows.length&gt;0) {
				var w = this.windows.pop();
				w.navigationIndex = null;
				w.popToRoot = true;
				w.close({ animated: false });
			} else {
				if (this.closeCallback) this.closeCallback();
				this.closeCallback = null;
			}
		},

		openWindow: function(window, args) {
			args = args || {};
			var self = this;

			if (OS_ANDROID) {
				if (args.animated!==false) {
					if (args.modal) {
						args.activityEnterAnimation = Ti.Android.R.anim.fade_in;
						args.activityExitAnimation = Ti.Android.R.anim.fade_out;
					} else {
						args.activityEnterAnimation = Ti.Android.R.anim.slide_in_left;
						args.activityExitAnimation = Ti.Android.R.anim.slide_out_right;
					}
				}
			}

			window.addEventListener(&#39;close&#39;, function(e){
				if (e.source.navigationIndex&gt;=0) {
					self.windows.splice(e.source.navigationWindow, 1);
				}
				if (e.source.popToRoot) self.close();
			});

			window.navigationIndex = this.windows.length;
			this.windows.push(window);

			return window.open(_.extend(args, { modal: false }));
		},

		closeWindow: function(window) {
			return window.close();
		},

		getWindowsStack: function() {
			return this.windows;
		}

	};

}

<span id='XPUI-method-createNavigationWindow'>/**
</span> * @method  createNavigationWindow
 *
 * ## iOS
 *
 * Nothing done.
 *
 * ## Android
 *
 * Create a **NavigationWindow-compatible** container that handle all windows in a stack.
 *
 * @param  {Object} args [description]
 */
exports.createNavigationWindow = function(args) {
	if (!OS_IOS) {
		return new NavigationWindow(args || {});
	}

	return Ti.UI.iOS.createNavigationWindow(args || {});
};




/* ============ WINDOW ============= */

<span id='XPUI-method-createWindow'>/**
</span> * @method createWindow
 *
 * ## iOS
 *
 * Nothing done.
 *
 * ## Android
 *
 * Adds the support for:
 *
 * * **rightNavButton**
 * * **title and subtitle**: automatically set the title and subtitle in the ActionBar
 *
 * @param  {Object} args
 */
exports.createWindow = function(args) {
	var $ui = Ti.UI.createWindow(args || {});

	if (OS_ANDROID) {

		$ui.addEventListener(&#39;open&#39;, function(e){
			if (!$ui.activity || !$ui.activity.actionBar) return;

			if ($ui.subtitle) {
				$ui.activity.actionBar.title = $ui.title;
				$ui.activity.actionBar.subtitle = $ui.subtitle;
			} else {
				if ($ui.subtitle===false) {
					$ui.activity.actionBar.title = $ui.title;
				} else {
					$ui.activity.actionBar.title =  Ti.App.name;
					$ui.activity.actionBar.subtitle = $ui.title;
				}
			}
		});

		$ui.setRightNavButton = function($btn){
			if (!$ui.activity) return;

			if ($btn===null) {

				$ui.activity.onCreateOptionsMenu = function(e){
					e.menu.items = [];
				};

			} else {

				while ($btn.children &amp;&amp; $btn.children[0]) $btn = $btn.children[0];
				$ui.activity.onCreateOptionsMenu = function(e){
					if (!$btn.title &amp;&amp; !$btn.image) {
						Ti.API.error(&quot;XP.UI: please specify a title OR icon/image for RightNavButton&quot;);
						return;
					}

					var menuItem = e.menu.add({
						title: $btn.title || &#39;&#39;,
						icon: $btn.icon || $btn.image || &#39;&#39;,
						showAsAction: Ti.Android.SHOW_AS_ACTION_ALWAYS
					});
					menuItem.addEventListener(&#39;click&#39;, function(){
						$btn.fireEvent(&#39;click&#39;);
					});
				};
			}

			if ($ui.activity.invalidateOptionsMenu) {
				$ui.activity.invalidateOptionsMenu();
			}
		};

		Object.defineProperty($ui, &#39;rightNavButton&#39;, { set: $ui.setNavButton });
		if (args.rightNavButton) $ui.setRightNavButton(args.rightNavButton);

	}

	return $ui;
};




/* ========== TEXTAREA =========== */

function __onTextAreaFocus(e) {
	if (!e.source.getRealValue().length) {
		e.source.applyProperties({
			value: &#39;&#39;,
			color: e.source.originalColor
		});
	}
}

function __onTextAreaBlur(e) {
	if (!e.source.value.length) {
		e.source.applyProperties({
			value: e.source.__hintText,
			color: e.source.hintTextColor || &#39;#AAA&#39;
		});
	} else {
		e.source.color = e.source.originalColor;
	}
}

function __enableAutoFocus(e) {
	e.source.softKeyboardOnFocus = Ti.UI.Android.SOFT_KEYBOARD_SHOW_ON_FOCUS;
}

<span id='XPUI-method-createTextField'>/**
</span> * @method  createTextField
 *
 * Added methods:
 *
 * * **getRealValue()**: get the effective value when using hintText hack
 *
 * Added properties:
 *
 * * **textType**: Can be *email* or *password*, and adjust the keyboard or the mask automatically.
 * * **realValue**: get the effective value when using hintText hack
 *
 * ## iOS
 *
 * Nothing done
 *
 * ## Android
 *
 * Removed the annoying autofocus.
 *
 * @param  {Object} args
 * @return {Ti.UI.TextField}
 */
exports.createTextField = function(args) {
	args = args || {};

	switch (args.textType) {
		case &#39;email&#39;:
		args.keyboardType = Ti.UI.KEYBOARD_EMAIL;
		break;
		case &#39;password&#39;:
		args.passwordMask = true;
		break;
	}

	var $this = Ti.UI.createTextField(args);

	if (OS_ANDROID) {
		$this.softKeyboardOnFocus = Ti.UI.Android.SOFT_KEYBOARD_HIDE_ON_FOCUS;
		$this.addEventListener(&#39;touchstart&#39;, __enableAutoFocus);
	}

	return $this;
};


<span id='XPUI-method-createTextArea'>/**
</span> * @method  createTextArea
 *
 * Added methods:
 *
 * * **getRealValue()**: get the effective value when using hintText hack
 *
 * Added properties:
 *
 * * **realValue**: get the effective value when using hintText hack
 *
 * ## iOS
 *
 * Adds xp-support for hintText, that is missing on iOS.
 *
 * ## Android
 *
 * Removed the annoying autofocus.
 *
 * @param  {Object} args
 * @return {Ti.UI.TextArea}
 */
exports.createTextArea = function(args) {
	args = args || {};

	var $this = Ti.UI.createTextArea(args || {});

	if (OS_IOS) {
		$this.__hintText = $this.hintText;
		$this.originalColor = $this.color || &#39;#000&#39;;
		$this.addEventListener(&#39;focus&#39;, __onTextAreaFocus);
		$this.addEventListener(&#39;blur&#39;, __onTextAreaBlur);
		__onTextAreaBlur({ source: $this });
	}

	if (OS_ANDROID) {
		$this.softKeyboardOnFocus = Ti.UI.Android.SOFT_KEYBOARD_HIDE_ON_FOCUS;
		$this.addEventListener(&#39;touchstart&#39;, __enableAutoFocus);
	}

	// Define a method to get the value when hintText hack is used
	$this.getRealValue = function(){
		if ($this.__hintText==$this.value) return &#39;&#39;;
		return $this.value;
	};
	Object.defineProperty($this, &#39;realValue&#39;, { get: $this.getRealValue });

	return $this;
};




/* ============= LABEL ============= */


/* Thanks to @lastguest: https://gist.github.com/lastguest/10277461 */
function simpleHTMLParser(text) {

	var tags_rx = /&lt;\s*(\/?\s*[^&gt;]+)(\s+[^&gt;]+)?\s*&gt;/gm,
	partial,
	tag,
	temp_style;

	var last_idx = 0,
	last_text_idx = 0;

	var style = [],
	style_stack = [],
	clean_text = [];

	while ((tag=tags_rx.exec(text))!==null) {
		partial = text.substr(last_idx, tag.index - last_idx);
		clean_text.push(partial);
		last_text_idx += partial.length;

		if (tag[1][0]==&#39;/&#39;){
			temp_style = style_stack.pop();
			temp_style.length = last_text_idx - temp_style.start;
			style.push(temp_style);
		} else {
			style_stack.push({
				type: tag[1],
				start: last_text_idx,
			});
		}
		last_idx = tags_rx.lastIndex;
	}

	clean_text.push(text.substr(last_idx));

	return {
		text: clean_text.join(&#39;&#39;),
		style: style
	};
}


<span id='XPUI-method-createLabel'>/**
</span> * @method createLabel
 *
 * ## iOS
 *
 * Add xp-support for **VERY BASIC** HTML.
 *
 * For now, supports `&lt;b&gt;&lt;i&gt;&lt;u&gt;&lt;br&gt;&lt;p&gt;` tags.
 *
 * If you specify `fontTransform` property in the arguments,
 * the specified transformation is applied to current font.
 * For example:
 *
 * ```
 * italic: {
 *		fontStyle: &#39;Italic&#39;
 *	},
 *	bold: {
 *		fontFamily: &#39;Arial-Bold&#39;
 *	}
 *	```
 *
 * It&#39;s useful if you don&#39;t have a regular font syntax.
 *
 * @param  {Object} args
 */
exports.createLabel = function(args) {
	var $this = Ti.UI.createLabel(args || {});

	if (OS_IOS) {

		var fontTransform = _.extend({
			italic: {
				fontStyle: &#39;Italic&#39;
			},
			bold: {
				fontWeight: &#39;Bold&#39;
			}
		}, args.fontTransform || {});

		$this.setHtml = function(value) {
			var htmlToAttrMap = {
				&#39;u&#39;: {
					type: Ti.UI.iOS.ATTRIBUTE_UNDERLINES_STYLE,
					value: Ti.UI.iOS.ATTRIBUTE_UNDERLINE_STYLE_SINGLE
				},
				&#39;i&#39;: {
					type: Ti.UI.iOS.ATTRIBUTE_FONT,
					value: args.fontTransformation_.extend(args.font, fontTransform.italic)
				},
				&#39;b&#39;: {
					type: Ti.UI.iOS.ATTRIBUTE_FONT,
					value: _.extend(args.font, fontTransform.bold)
				}
			};

			var parseResult = simpleHTMLParser(value.replace(/&lt;br\/?&gt;/g, &quot;\n&quot;).replace(/&lt;p&gt;/g, &#39;&#39;).replace(/&lt;\/p&gt;/g, &quot;\n\n&quot;));
			var attributedString = {
				text: parseResult.text,
				attributes: []
			};

			_.each(parseResult.style, function(v){
				if (v.type in htmlToAttrMap) {
					attributedString.attributes.push(_.extend(_.clone(htmlToAttrMap[v.type]), {
						range: [ v.start, v.length ]
					}));
				}
			});

			$this.attributedString = Ti.UI.iOS.createAttributedString(attributedString);
		};

		if ($this.html) $this.setHtml($this.html);
	}

	return $this;
};



<span id='XPUI-method-createListView'>/**
</span> * @method createListView
 *
 * Added listeners:
 *
 * * **itemdblclick**: Similar to itemclick, but for double **item** click
 *
 * @param  {Object} args
 */
exports.createListView = function(args) {
	var $this = Ti.UI.createListView(args || {});

	var DBL_CLICK_TIMEOUT = 500;
	var devtClick = {};
	var devtTime = 0;

	$this.addEventListener(&#39;itemclick&#39;, function(e){
		var evtTime = +(new Date());
		var evtClick = {
			itemId: e.itemId,
			bindId: e.bindId,
			sectionIndex: e.sectionIndex,
			itemIndex: e.itemIndex
		};
		if (evtTime-devtTime&lt;DBL_CLICK_TIMEOUT &amp;&amp; _.isEqual(devtClick, evtClick)) {
			evtClick.section = e.section;
			$this.fireEvent(&#39;itemdblclick&#39;, evtClick);
			evtClick = {}; // prevent non 2n-clicks
		}
		devtTime = evtTime;
		devtClick = evtClick;
	});

	return $this;
};


<span id='XPUI-method-createTabbedBar'>/**
</span> * @method createTabbedBar
 *
 * Create a TabbedBar fully compatible with Android
 *
 * @param  {Object} args
 */
exports.createTabbedBar = function(args) {
	args = args || {};
	if (OS_IOS) {
		return Ti.UI.iOS.createTabbedBar(args);
	}

	var $this = Ti.UI.createView(args);

	$this._labels = [];
	$this.getLabels = function() { return $this._labels; };
	$this.setLabels = function(lbls) {
		$this._labels = [];
		_.each(lbls, function(l, i){
			$this._labels.push(_.isObject(l) ? l.title : l);
		});

		var width = Math.floor(100/$this._labels.length)+&#39;%&#39;;
		var $wrap = Ti.UI.createView({
			layout: &#39;horizontal&#39;,
		});

		_.each($this._labels, function(l, index){
			$wrap.add(Ti.UI.createButton({
				title: l,
				index: index,
				width: width,
				left: 0,
				right: 0,
				height: 32,
				borderColor: args.tintColor || &#39;#000&#39;,
				borderWidth: 1,
				font: args.font || {},
				backgroundColor: &#39;transparent&#39;,
				color: args.tintColor || &#39;#000&#39;
			}));
		});

		if ($this.wrap) $this.remove($this.wrap);
		$this.wrap = $wrap; $this.add($this.wrap);

		if ($this._index) {
			$this.setIndex($this._index);
		}
	};

	Object.defineProperty($this, &#39;labels&#39;, {
		set: $this.setLabels, get: $this.getLabels
	});


	$this._index = 0;
	$this.getIndex = function() { return $this._index; };
	$this.setIndex = function(i) {
		$this._index = +i;

		if (!$this.wrap.children || !$this.wrap.children.length) return;
		_.each($this.wrap.children, function($c, _i) {
			if (_i==$this._index) {
				$c.applyProperties({
					backgroundColor: args.tintColor || &#39;#000&#39;,
					color: args.backgroundColor || &#39;#fff&#39;,
					active: false
				});
			} else {
				$c.applyProperties({
					backgroundColor: &#39;transparent&#39;,
					color: args.tintColor || &#39;#000&#39;,
					active: true
				});
			}
		});
	};

	Object.defineProperty($this, &#39;index&#39;, {
		set: $this.setIndex, get: $this.getIndex
	});

	$this.addEventListener(&#39;click&#39;, function(e){
		if (&#39;index&#39; in e.source) {
			$this.setIndex(+e.source.index);
		}
	});

	if (args.labels) $this.setLabels(args.labels);
	$this.setIndex(args.index!==undefined ? args.index : 0);

	return $this;
};</pre>
</body>
</html>
